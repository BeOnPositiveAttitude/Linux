Утилита `cron` хорошо подходит для повторяющихся задач, которые выполняются каждые несколько минут/часов или в определенные дни. Также она позволяет задать определенное точное время, в которое должна запуститься задача.

Утилита `anacron` также подходит для повторяющихся задач, но она НЕ может исполнять их каждые несколько минут/часов. Минимальная единица времени, с которой работает `anacron` - это день. Соответственно утилита может запускать задачи каждый день, каждые несколько дней, каждую неделю, каждый месяц и т.д. При использовании `anacron` нам неважно в какое именно время начнется выполнение задачи. Мы просто хотим, чтобы задача выполнялась каждый месяц/неделю/день.

`cron` может пропустить выполнение задачи. Например, если сервер находился в выключенном состоянии и затем включен в 00:05, а выполнение задачи было запланировано на 00:01, то задача не будет выполнена cron-ом в этот день. `anacron` в свою очередь выполнит задачу как только сервер будет включен.

| Cron | Anacron |
| ----------- | ----------- |
| Является службой | НЕ является службой |
| Подходит для серверов | Подходит для ПК и ноутбуков |
| Позволяет запускать запланированные задания каждую минуту | Позволяет запускать запланированные задания только на ежедневной основе |
| Если машина выключена, запланированное задание НЕ выполнится | Если машина выключена, выполнит запланированное задание при следующем включении машины |
| Может использоваться как локальными пользователями, так и суперпользователем root | Может использоваться только суперпользователем root, если не указано иное (включено для обычных пользователей с конкретными настройками) |

---

Основное различие между `cron` и `anacron` заключается в том, что `cron` эффективно работает на машинах, которые будут работать непрерывно, в то время как `anacron` предназначен для машин, которые периодически могут выключаться.

Утилита `at` подходит для одноразового запуска задач.

### cron

Установка демона crond: `yum install -y cronie`.

Из файла `/etc/crontab ` можно взять синтаксис `anacron`. Это system-wide cron table, поэтому не нужно вносить изменения напрямую в этот файл.

```
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed

35 6 * * * root /bin/some_command --some_options
```

Указывается полный путь к исполняемому файлу, который можно узнать с помощью команды `which`.

- `*` - match all possible values, every hour
- `,` - match multiple values, `15,30`
- `-` - range of values, `2-4`
- `/` - specifies steps, `*/4`

Можно комбинировать указанные выше опции, например `0-8/4`.

Редактировать cron table текущего пользователя: `crontab -e`.

Например: `35 6 * * * /usr/bin/touch test_passed`. Здесь имя пользователя можно не указывать, т.к. мы редактируем пользовательский cron table и `cron` знает под каким пользователем будет выполняться команда.

Созданная таким образом задача хранится в каталоге `/var/spool/cron/crontabs/`.

Смотреть cron table текущего пользователя: `crontab -l`.

Смотреть cron table для root-a: `sudo crontab -l`.

Редактировать cron table пользователя jane: `sudo crontab -e -u jane`. Здесь `u = user`.

Удалить cron table для текущего пользователя: `crontab -r`. Здесь `r = remove`.

Удалить cron table пользователя jane: `crontab -r -u jane`.

Существует несколько директорий для размещения `cron` задач:

- `/etc/cron.daily` - выполняются каждый день
- `/etc/cron.hourly` - выполняются каждый час
- `/etc/cron.monthly` - выполняются каждый месяц
- `/etc/cron.weekly` - выполняются каждую неделю

Предположим, что нам нужно запускать скрипт с помощью `cron`.

Первое - скрипт не должен иметь `.sh` в названии.

Копируем скрипт в соответствующую директорию из списка выше: `sudo cp shellscript /etc/cron.hourly/`.

Даем ему права на чтение/исполнение: `sudo chmod +rx /etc/cron.hourly/shellscript`.

Чтобы ограничить доступ к выполнению `cron`-задач определенным пользователям создаем файл `/etc/cron.deny` и добавляем туда логины в столбик.

Чтобы разрешить доступ к выполнению `cron`-задач определенным пользователям создаем файл `/etc/cron.allow` и добавляем туда логины в столбик.

### anacron

Чтобы запланировать задачу с помощью `anacron` нужно отредактировать файл `/etc/anacrontab`.

Формат:

```
#period in days   delay in minutes   job-identifier   command
3                 10                 test-job         /usr/bin/touch /root/anacron_created_this
```

- `3` - запускать задачу каждые три дня
- `10` - запускать задачу с задержкой в 10 минут (например, если машина была выключена и при запуске начнет выполнение сразу 15 пропущенных задач, то это создаст нездоровую нагрузку, поэтому вводится задержка)
- `test-job` - идентификатор задачи, будет указан в логах
- `/usr/bin/touch /root/anacron_created_this` - команда, которая будет выполняться

Для запуска задачи каждую неделю:

```
#period in days   delay in minutes   job-identifier   command
7                 10                 test-job         /usr/bin/touch /root/anacron_created_this
```

Или так:

```
#period in days   delay in minutes   job-identifier   command
@weekly           10                 test-job         /usr/bin/touch /root/anacron_created_this
```

Для запуска задачи каждый месяц:

```
#period in days   delay in minutes   job-identifier   command
@monthly          10                 test-job         /usr/bin/touch /root/anacron_created_this
```

Запустить все запланированные джобы прямо сейчас: `sudo anacron -n`. Здесь `n = now`. Если джоба уже запускалась сегодня, то повторно она не запустится.

Запустить все запланированные джобы принудительно прямо сейчас, даже если джоба уже запускалась сегодня: `sudo anacron -n -f`. Здесь `f = force`.

Протестировать корректность `anacron`-задачи в плане синтаксиса: `anacron -T`.

### at

Для планирования задачи с помощью утилиты `at` вводим команду: `at 15:00`.

```
warning: commands will be executed using /bin/sh
at Tue May  7 10:30:00 2024
at> /usr/bin/touch /home/aidar/Downloads/file_created_by_at
at> /usr/bin/touch /home/aidar/Downloads/file_created_by_at2
at> <EOT>
job 1 at Tue May  7 10:30:00 2024
```

После ввода последней команды нажимаем `Enter` и далее `Ctrl + D`.

Для запуска задачи в определенный день: `at 'August 20 2022'`.

Для запуска задачи в определенные день и время: `at '2:30 August 20 2022'`.

Для запуска задачи через 30 минут от настоящего момента времени: `at 'now + 30 minutes'`.

Для запуска задачи через 3 часа от настоящего момента времени: `at 'now + 3 hours'`.

Для запуска задачи через 3 дня от настоящего момента времени: `at 'now + 3 days'`.

Для запуска задачи через 3 недели от настоящего момента времени: `at 'now + 3 weeks'`.

Для запуска задачи через 3 месяца от настоящего момента времени: `at 'now + 3 months'`.

Смотреть запланированные задания: `atq`. Отсюда можно узнать id джобы.

Смотреть детальные свойства джобы c id 20: `at -c 20`. Здесь `c = cat`.

Удалить джобу с id 20: `atrm 20`.
